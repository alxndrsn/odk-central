#!/bin/bash -eux
set -o pipefail

alreadyRunMarkerFile="$PGDATANEW/../.odk-postgres-9.6-to-15-migration-completed-ok"

logPrefix="$(basename $0)"
log() {
  echo "$(TZ=GMT date) [$logPrefix] $*"
}

log "Checking for existing migration marker file..."
if [[ -f "$alreadyRunMarkerFile" ]]; then
  log "Migration has been run previously."
else
  if [[ -f "$PGDATAOLD/PG_VERSION" ]]; then (
    log "Migration not run previously; migrating now..."

    log "From: $PGDATAOLD"
    log "  To: $PGDATANEW"

    # standard ENTRYPOINT/CMD combo from parent Dockerfile
    if ! docker-upgrade pg_upgrade; then
      log "!!!"
      log "!!! pg_upgrade FAILED; dumping log files..."
      log "!!!"
      ls -halt # FIXME this line for debug only
      tail -n+1 pg_upgrade_*.log || log "No pg_upgrade log files found ¯\_(ツ)_/¯"
      log "!!!"
      log "!!! pg_upgrade FAILED; check above for clues."
      log "!!!"
      exit 1
    fi

    # see https://github.com/tianon/docker-postgres-upgrade/issues/16,
    #     https://github.com/tianon/docker-postgres-upgrade/issues/1
    cp "$PGDATAOLD/pg_hba.conf" "$PGDATANEW/pg_hba.conf"

    log "Starting postgres server for maintenance..."
    gosu postgres pg_ctl -D "$PGDATANEW" -l logfile start

    # As recommended by pg_upgrade:
    log "Updating extensions..."
    psql -f update_extensions.sql

    # As recommended by pg_upgrade:
    log "Regenerating optimizer statistics..."
    /usr/lib/postgresql/15/bin/vacuumdb --all --analyze-in-stages

    log "Stopping postgres server..."
    gosu postgres pg_ctl -D "$PGDATANEW" -m smart stop

    # pg_upgrade recommends running ./delete_old_cluster.sh, which
    # just runs `rm -rf '/var/lib/postgresql/data'`.  Doing this here
    # can fail with "Device or resource busy".  In addition, deleting
    # the old data may be risky if the migration didn't complete
    # perfectly.  We can hedge our bets and make life easier by
    # skipping cleanup here, and providing a docker command to prune
    # the old, unused volume in the next odk-central version.
    # TODO REVIEW THIS! ^^^
    log "Removing legacy data..."
    cat ./delete_old_cluster.sh
    sleep 10
    ./delete_old_cluster.sh

    log "Migration complete."
  ) > >(tee --append "/migration-logs/migrate-postgres-9.6-15.log" >&2) 2>&1
  else
    log "No legacy data found."
  fi
  touch "$alreadyRunMarkerFile"
  touch "/migration-logs/migrate-postgres-9.6-15.completed.ok"
fi

log "Shutting down."
