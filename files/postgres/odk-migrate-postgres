#!/bin/bash -eux
set -o pipefail

alreadyRunMarkerFile="$PGDATANEW/../.odk-9.6-to-14-migration-completed-ok"

logPrefix="$(basename $0)"
log() {
  echo "$(TZ=GMT date) [$logPrefix] $*"
}

log "Checking for existing migration marker file..."
if [[ -f "$alreadyRunMarkerFile" ]]; then
  log "Migration has been run previously."
else
  if [[ -f "$PGDATAOLD/PG_VERSION" ]]; then (
    log "Migration not run previously; migrating now..."

    # --link should take less disk space, but doesn't work on MacOSX on github actions
    # TODO work out why and if there is a better way to approach this
    docker-upgrade pg_upgrade --link || docker-upgrade pg_upgrade

    # see https://github.com/tianon/docker-postgres-upgrade/issues/16,
    #     https://github.com/tianon/docker-postgres-upgrade/issues/1
    cp "$PGDATAOLD/pg_hba.conf" "$PGDATANEW/pg_hba.conf"

    log "Starting postgres server for maintenance..."
    gosu postgres pg_ctl -D "$PGDATANEW" -l logfile start

    # As recommended by pg_upgrade:
    log "Updating extensions..."
    psql -f update_extensions.sql

    # As recommended by pg_upgrade:
    log "Regenerating optimizer statistics..."
    /usr/lib/postgresql/14/bin/vacuumdb --all --analyze-in-stages

    log "Stopping postgres server..."
    gosu postgres pg_ctl -D "$PGDATANEW" -m smart stop

    # pg_upgrade recommends running ./delete_old_cluster.sh, which
    # just runs `rm -rf '/var/lib/postgresql/data'`.  Doing this here
    # can fail with "Device or resource busy".  In addition, deleting
    # the old data may be risky if the migration didn't complete
    # perfectly.  We can hedge our bets and make life easier by
    # skipping cleanup here, and providing a docker command to prune
    # the old, unused volume in the next odk-central version.
    # TODO REVIEW THIS! ^^^

    log "Migration complete."
  ) 2> >(tee "$PGDATANEW/../.migrate-9.6-14.log" >&2)
  else
    log "No legacy data found."
  fi
  touch "$alreadyRunMarkerFile"
fi

log "Shutting down."
